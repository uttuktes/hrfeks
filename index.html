<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form Evaluasi Kinerja Staf</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <style>
    body { background:#f8fafc; color:#0f172a; }
    
    /* PERKECIL UKURAN FORM 20% */
    .card { border:1px solid #111827; border-radius:.5rem; background:#fff; overflow:hidden; }
    .card-header { background:#111827; color:#fff; padding:0.5rem 0.8rem; }
    .card-sub { color:#94a3b8; font-size:.8rem; margin-top:.25rem; }
    .card-body { padding:0.6rem; }
    .lbl-small { font-size:.85rem; color:#0f172a; }
    .val-badge { min-width:40px; text-align:center; font-weight:600; color:#0f172a; font-size:0.9rem; }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(to right, #4285f4 var(--pos,50%), #e6e7e9 var(--pos,50%));
      outline: none;
      margin: 0;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4285f4;
      border: 2px solid white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      cursor: pointer;
      margin-top: -5px;
    }
    
    /* Styling untuk card aktif */
    .swiper-slide-active .karyawan-card {
      background-color: #eff6ff;
      border-color: #3b82f6;
      border-width: 2px;
      box-shadow: 0 5px 15px -5px rgba(59, 130, 246, 0.5);
    }

    /* Indicator karyawan */
    .karyawan-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      margin: 0 2px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .karyawan-indicator.active {
      background: #3b82f6;
      transform: scale(1.2);
    }
    .karyawan-indicator.filled {
      background: #10b981;
    }

    /* Animasi loading */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .loading-pulse {
      animation: pulse 1.5s ease-in-out infinite;
    }

    /* Navigasi panah */
    .karyawan-navigation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin: 12px 0 4px;
    }
    
    .nav-arrow {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: white;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #3b82f6;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .nav-arrow:hover:not(:disabled) {
      background: #f8fafc;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .nav-arrow:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Container dengan partial visibility */
    .swiper-container-wrapper {
      position: relative;
      overflow: hidden;
      border-radius: 10px;
    }
    
    .swiper-container-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
      width: 30px;
      background: linear-gradient(to right, transparent, white);
      pointer-events: none;
      z-index: 5;
      opacity: 0.7;
      border-radius: 0 10px 10px 0;
    }

    /* Hilangkan gradient jika hanya 1 karyawan */
    .swiper-container-wrapper.single-karyawan::after {
      display: none;
    }

    /* Hint text */
    .swipe-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: #64748b;
      font-size: 12px;
      margin: 4px 0 2px;
    }

    .swipe-hint span {
      font-size: 16px;
      color: #3b82f6;
    }

    /* Sembunyikan hint jika hanya 1 karyawan */
    .swipe-hint.single-karyawan {
      display: none;
    }

    /* Card styling */
    .karyawan-card {
      position: relative;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      padding: 0.8rem !important;
    }

    /* Badge centang */
    .badge-dinilai {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 10px;
      background: #10b981;
      color: white;
      padding: 2px 6px;
      border-radius: 999px;
    }

    /* STICKY SECTION */
    .sticky-karyawan {
      position: sticky;
      top: 12px;
      z-index: 40;
      transition: all 0.2s ease;
    }

    .sticky-karyawan.is-sticky {
      box-shadow: 0 5px 15px -5px rgba(0, 0, 0, 0.1);
    }

    /* Scroll margin */
    .scroll-margin {
      scroll-margin-top: 70px;
    }

    /* HAPUS BULLET POINT */
    .no-bullet {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }

    /* SEMBUNYIKAN PAGINATION DOTS */
    .swiper-pagination {
      display: none !important;
    }

    /* Perkecil jarak antar section */
    .space-y-4 {
      margin-top: 0.8rem !important;
    }

    .space-y-3 {
      margin-top: 0.5rem !important;
    }

    .gap-3 {
      gap: 0.5rem !important;
    }

    .p-4 {
      padding: 0.8rem !important;
    }

    /* Perkecil teks di header card */
    .card-header .font-semibold {
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="max-w-3xl mx-auto p-3 sm:p-4">
    <img src="https://media.licdn.com/dms/image/v2/D4E3DAQHdQ8hI0F8kFw/image-scale_191_1128/image-scale_191_1128/0/1729146506484/espera_satya_cover?e=2147483647&amp;v=beta&amp;t=Li35iFgVbilg53Our-rLWfp4cdXEVmF1ZzX6mRVCLfw" alt="Espera Satya" class="w-full h-28 object-cover object-right rounded-t-lg mb-2">

    <form id="formEval" class="space-y-3">
      <!-- PERIODE EVALUASI -->
      <section class="card">
        <div class="card-header">
          <div class="font-semibold">Periode Evaluasi</div>
        </div>
        <div class="card-body">
          <select id="periode" name="periode" class="p-1.5 border rounded w-full md:w-1/2 text-sm" required>
            <option value="">Pilih Periode Evaluasi *</option>
            <option value="CW1">November - Februari</option>
            <option value="CW2">Maret - Juni</option>
            <option value="CW3">Juli - Oktober</option>
          </select>
        </div>
      </section>

      <!-- DATA PENILAI -->
      <section class="card">
        <div class="card-header">
          <div class="font-semibold">Data Nama Penilai</div>
        </div>
        <div class="card-body grid grid-cols-1 md:grid-cols-3 gap-2">
          <select id="namaPenilai" name="namaPenilai" class="p-1.5 border rounded text-sm" required>
            <option value="">Pilih Nama Penilai *</option>
          </select>
          <input id="departemen" name="departemen" placeholder="Departemen *" class="p-1.5 border rounded bg-gray-100 text-sm" readonly required>
        </div>
      </section>

      <!-- DATA KARYAWAN DENGAN STICKY -->
      <section class="card sticky-karyawan" id="karyawanSection">
        <div class="card-header">
          <div class="font-semibold">Data Karyawan</div>
          <div class="card-sub flex items-center gap-2" id="karyawanStatus">
            <span id="karyawanCounter" class="text-xs">0 karyawan</span>
            <span class="mx-1">|</span>
            <span id="karyawanIndicator" class="flex gap-1"></span>
          </div>
        </div>
        <div class="card-body">
          <!-- AREA LOADING -->
          <div id="loadingKaryawan" class="hidden flex flex-col items-center justify-center py-6">
            <div class="flex items-center gap-2 text-blue-600 font-medium text-base loading-pulse">
              <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span>Loading data karyawan...</span>
            </div>
          </div>

          <div id="sectionKaryawan" class="hidden">
            <!-- Navigasi Panah + Swiper -->
            <div class="karyawan-navigation" id="karyawanNavigation">
              <button type="button" class="nav-arrow" id="prevKaryawan" disabled>←</button>
              
              <div class="swiper-container-wrapper flex-1" id="swiperWrapper">
                <div class="swiper mySwiper">
                  <div class="swiper-wrapper" id="swiperKaryawan"></div>
                </div>
              </div>
              
              <button type="button" class="nav-arrow" id="nextKaryawan" disabled>→</button>
            </div>

            <!-- Hint text - akan disembunyikan jika hanya 1 karyawan -->
            <div class="swipe-hint no-bullet" id="swipeHint">
              <span>←</span> Geser atau klik panah untuk lihat karyawan lain <span>→</span>
            </div>
          </div>

          <div id="noKaryawanMessage" class="hidden text-center py-4 text-gray-500 text-sm">
            Tidak ada karyawan di departemen ini
          </div>
        </div>
        <input type="hidden" id="currentKaryawanIndex" value="-1">
        <input type="hidden" id="nama" name="nama">
        <input type="hidden" id="posisi" name="posisi">
      </section>

      <!-- KOMPETENSI -->
      <section class="card scroll-margin" id="kompetensiSection">
        <div class="card-header">
          <div class="font-semibold">KOMPETENSI</div>
          <div class="card-sub">&gt;15 = Tinggi | 9–15 = Sedang | &lt;9 = Rendah</div>
        </div>
        <div class="card-body space-y-2">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
            <label class="lbl-small">1. Keterampilan Kerja</label>
            <div class="sm:col-span-1">
              <input class="slider kompetensi w-full" type="range" name="comp1" min="0" max="20" value="0">
            </div>
            <div class="val-badge" data-for="comp1">0</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
            <label class="lbl-small">2. Pengetahuan</label>
            <div class="sm:col-span-1">
              <input class="slider kompetensi w-full" type="range" name="comp2" min="0" max="20" value="0">
            </div>
            <div class="val-badge" data-for="comp2">0</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
            <label class="lbl-small">3. Pengalaman</label>
            <div class="sm:col-span-1">
              <input class="slider kompetensi w-full" type="range" name="comp3" min="0" max="20" value="0">
            </div>
            <div class="val-badge" data-for="comp3">0</div>
          </div>
        </div>
      </section>

      <!-- KAPASITAS -->
      <section class="card scroll-margin">
        <div class="card-header">
          <div class="font-semibold">KAPASITAS</div>
          <div class="card-sub">&gt;15 = Kuat | 9–15 = Sedang | &lt;9 = Lemah</div>
        </div>
        <div class="card-body space-y-2">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
            <label class="lbl-small">1. Fisik</label>
            <div class="sm:col-span-1"><input class="slider kapasitas w-full" type="range" name="kap1" min="0" max="20" value="0"></div>
            <div class="val-badge" data-for="kap1">0</div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
            <label class="lbl-small">2. Mental</label>
            <div class="sm:col-span-1"><input class="slider kapasitas w-full" type="range" name="kap2" min="0" max="20" value="0"></div>
            <div class="val-badge" data-for="kap2">0</div>
          </div>
        </div>
      </section>

      <!-- PROFESIONALISME -->
      <section class="card scroll-margin">
        <div class="card-header">
          <div class="font-semibold">PROFESIONALISME KERJA</div>
          <div class="card-sub">&gt;40 = Sangat Baik | 30–40 = Baik | 19–29 = Sedang | &lt;19 = Kurang</div>
        </div>
        <div class="card-body space-y-2">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">1. Pemahaman kebijakan mutu</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p1" min="0" max="50" value="0">
              <div class="val-badge" data-for="p1">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">2. Pengembangan diri & peningkatan performa kerja</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p2" min="0" max="50" value="0">
              <div class="val-badge" data-for="p2">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">3. Perencanaan & pengendalian kualitas kerja</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p3" min="0" max="50" value="0">
              <div class="val-badge" data-for="p3">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">4. Pencapaian target produktivitas kinerja</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p4" min="0" max="50" value="0">
              <div class="val-badge" data-for="p4">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">5. Inisiatif / Gagasan baru</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p5" min="0" max="50" value="0">
              <div class="val-badge" data-for="p5">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">6. Tanggung jawab dalam menjalankan pekerjaan</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p6" min="0" max="50" value="0">
              <div class="val-badge" data-for="p6">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">7. Pendekatan interpersonal dengan tim</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p7" min="0" max="50" value="0">
              <div class="val-badge" data-for="p7">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">8. Komunikasi dalam tim</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p8" min="0" max="50" value="0">
              <div class="val-badge" data-for="p8">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">9. Target Administrasi (Laporan / Deadline)</label>
            <div class="flex items-center gap-2">
              <input class="slider profesional flex-1" type="range" name="p9" min="0" max="50" value="0">
              <div class="val-badge" data-for="p9">0</div>
            </div>
          </div>
        </div>
      </section>

      <!-- KARAKTER -->
      <section class="card scroll-margin">
        <div class="card-header">
          <div class="font-semibold">KARAKTER & KAPASITAS KERJA</div>
          <div class="card-sub">&gt;30 = Sangat Baik | 20–30 = Baik | 9–19 = Sedang | &lt;19 = Kurang</div>
        </div>
        <div class="card-body space-y-2">
          <!-- 10 item dengan gap diperkecil -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">1. Orientasi terhadap proses & hasil kerja</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k1" min="0" max="40" value="0">
              <div class="val-badge" data-for="k1">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">2. Integritas (kedisiplinan, kebersihan, loyalitas)</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k2" min="0" max="40" value="0">
              <div class="val-badge" data-for="k2">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">3. Kontribusi terhadap strategi bisnis</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k3" min="0" max="40" value="0">
              <div class="val-badge" data-for="k3">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">4. Menghormati atasan & rekan kerja</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k4" min="0" max="40" value="0">
              <div class="val-badge" data-for="k4">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">5. Kerja sama tim</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k5" min="0" max="40" value="0">
              <div class="val-badge" data-for="k5">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">6. Kemampuan beradaptasi</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k6" min="0" max="40" value="0">
              <div class="val-badge" data-for="k6">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">7. Pemecahan masalah & ketepatan keputusan</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k7" min="0" max="40" value="0">
              <div class="val-badge" data-for="k7">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">8. Kedewasaan dalam bersikap</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k8" min="0" max="40" value="0">
              <div class="val-badge" data-for="k8">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">9. Semangat kerja & kemampuan belajar</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k9" min="0" max="40" value="0">
              <div class="val-badge" data-for="k9">0</div>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 items-center">
            <label class="lbl-small">10. Kepemimpinan</label>
            <div class="flex items-center gap-2">
              <input class="slider karakter flex-1" type="range" name="k10" min="0" max="40" value="0">
              <div class="val-badge" data-for="k10">0</div>
            </div>
          </div>
        </div>
      </section>

      <div class="text-right">
        <button id="btnSubmit" type="submit" class="px-4 py-1.5 rounded bg-blue-500 text-white hover:bg-blue-600 disabled:bg-gray-400 text-sm" disabled>Submit</button>
      </div>
    </form>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxEE4-FcHehbFQ98XfmFTHsziah2XGZUaQJhhAN3e40Qq_JP_0Fb8kozQ6VURzpBW3y/exec';
    
    // ============ STATE MANAGEMENT ============
    let swiperInstance = null;
    let currentKaryawanList = [];
    let penilaianState = {};
    
    // Daftar semua slider
    const SLIDER_NAMES = [
      'comp1', 'comp2', 'comp3',
      'kap1', 'kap2',
      'p1', 'p2', 'p3', 'p4', 'p5', 'p6', 'p7', 'p8', 'p9',
      'k1', 'k2', 'k3', 'k4', 'k5', 'k6', 'k7', 'k8', 'k9', 'k10'
    ];

    // ============ FETCH ============
    async function fetchFromGAS(action, params = {}) {
      const url = new URL(GAS_URL);
      url.searchParams.set('action', action);
      Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
      
      const res = await fetch(url);
      const json = await res.json();
      if (!json.success) throw new Error(json.error || 'Error fetch');
      return json.data;
    }

    // ============ LOAD PENILAI ============
    async function loadPenilai() {
      const data = await fetchFromGAS('getAllPenilai');
      const select = document.getElementById('namaPenilai');
      select.innerHTML = `<option value="">Pilih Nama Penilai *</option>`;
      
      data.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.nama;
        opt.textContent = r.nama;
        opt.dataset.departemen = r.departemen;
        opt.dataset.jabatan = r.jabatan;
        select.appendChild(opt);
      });
    }

    // ============ RESET SEMUA SLIDER KE 0 ============
    function resetAllSlidersToZero() {
      SLIDER_NAMES.forEach(sliderName => {
        const slider = document.querySelector(`input[name="${sliderName}"]`);
        if (slider) {
          slider.value = 0;
          setRangeVisual(slider);
        }
      });
    }

    // ============ FUNGSI UNTUK MENYESUAIKAN TAMPILAN BERDASARKAN JUMLAH KARYAWAN ============
    function adjustUIBasedOnCount() {
      const count = currentKaryawanList.length;
      const navArrows = document.getElementById('karyawanNavigation');
      const swipeHint = document.getElementById('swipeHint');
      const swiperWrapper = document.getElementById('swiperWrapper');
      
      if (count <= 1) {
        // Sembunyikan panah dan hint
        if (navArrows) {
          const prevBtn = document.getElementById('prevKaryawan');
          const nextBtn = document.getElementById('nextKaryawan');
          if (prevBtn) prevBtn.style.display = 'none';
          if (nextBtn) nextBtn.style.display = 'none';
        }
        if (swipeHint) {
          swipeHint.classList.add('single-karyawan');
        }
        if (swiperWrapper) {
          swiperWrapper.classList.add('single-karyawan');
        }
      } else {
        // Tampilkan panah dan hint
        if (navArrows) {
          const prevBtn = document.getElementById('prevKaryawan');
          const nextBtn = document.getElementById('nextKaryawan');
          if (prevBtn) prevBtn.style.display = 'flex';
          if (nextBtn) nextBtn.style.display = 'flex';
        }
        if (swipeHint) {
          swipeHint.classList.remove('single-karyawan');
        }
        if (swiperWrapper) {
          swiperWrapper.classList.remove('single-karyawan');
        }
      }
    }

    // ============ LOAD KARYAWAN DENGAN LOADING REAL ============
    async function loadKaryawanByDept(dept) {
      if (!dept) return;

      const wrapper = document.getElementById('swiperKaryawan');
      const section = document.getElementById('sectionKaryawan');
      const noMessage = document.getElementById('noKaryawanMessage');
      const loadingEl = document.getElementById('loadingKaryawan');
      const counter = document.getElementById('karyawanCounter');
      
      section.classList.add('hidden');
      noMessage.classList.add('hidden');
      loadingEl.classList.remove('hidden');
      wrapper.innerHTML = '';
      counter.textContent = '0 karyawan';
      document.getElementById('karyawanIndicator').innerHTML = '';
      
      document.getElementById('prevKaryawan').disabled = true;
      document.getElementById('nextKaryawan').disabled = true;
      
      try {
        const data = await fetchFromGAS('getKaryawanByDept', { departemen: dept });
        
        loadingEl.classList.add('hidden');
        currentKaryawanList = data;

        data.forEach((karyawan) => {
          const key = karyawan.nama;
          if (!penilaianState[key]) {
            penilaianState[key] = {};
            SLIDER_NAMES.forEach(slider => {
              penilaianState[key][slider] = 0;
            });
          }
        });

        if (data.length > 0) {
          renderKaryawanSlides();
          renderKaryawanIndicator();
          
          document.getElementById('currentKaryawanIndex').value = 0;
          resetAllSlidersToZero();
          loadPenilaianForKaryawan(0);
          updateActiveKaryawan(0);
          
          // Sesuaikan UI berdasarkan jumlah karyawan
          adjustUIBasedOnCount();
          
          // Enable tombol panah hanya jika lebih dari 1 karyawan
          if (data.length > 1) {
            document.getElementById('prevKaryawan').disabled = true;
            document.getElementById('nextKaryawan').disabled = false;
          } else {
            document.getElementById('prevKaryawan').disabled = true;
            document.getElementById('nextKaryawan').disabled = true;
          }
        } else {
          noMessage.classList.remove('hidden');
          noMessage.textContent = 'Tidak ada karyawan di departemen ini';
          section.classList.add('hidden');
          counter.textContent = '0 karyawan';
        }

      } catch (error) {
        loadingEl.classList.add('hidden');
        noMessage.classList.remove('hidden');
        noMessage.innerHTML = '❌ Gagal memuat data karyawan. <br> Silakan coba lagi.';
        section.classList.add('hidden');
        console.error(error);
      }
    }

    // ============ RENDER SLIDE KARYAWAN ============
    function renderKaryawanSlides() {
      const wrapper = document.getElementById('swiperKaryawan');
      const section = document.getElementById('sectionKaryawan');
      const noMessage = document.getElementById('noKaryawanMessage');
      const counter = document.getElementById('karyawanCounter');
      
      wrapper.innerHTML = '';

      if (currentKaryawanList.length === 0) {
        section.classList.add('hidden');
        noMessage.classList.remove('hidden');
        counter.textContent = '0 karyawan';
        document.getElementById('btnSubmit').disabled = true;
        return;
      }

      noMessage.classList.add('hidden');
      section.classList.remove('hidden');
      counter.textContent = `${currentKaryawanList.length} karyawan`;
      
      currentKaryawanList.forEach((k, index) => {
        const key = k.nama;
        const isFilled = penilaianState[key] && Object.values(penilaianState[key]).some(v => v > 0);
        
        const slide = document.createElement('div');
        slide.className = 'swiper-slide';
        slide.innerHTML = `
          <div class="border rounded-lg p-3 shadow-md text-center cursor-pointer hover:shadow-lg transition karyawan-card relative ${index === 0 ? 'bg-blue-50 border-blue-500 border-2' : ''}" style="padding: 0.8rem !important;"
               data-nama="${k.nama}"
               data-jabatan="${k.jabatan}"
               data-index="${index}">
            <div class="font-semibold text-base">${k.nama}</div>
            <div class="text-xs text-gray-500">${k.jabatan}</div>
            ${isFilled ? '<span class="badge-dinilai">✓</span>' : ''}
          </div>
        `;
        
        wrapper.appendChild(slide);
      });

      if (swiperInstance) swiperInstance.destroy(true, true);
      
      swiperInstance = new Swiper('.mySwiper', {
        slidesPerView: 1,
        spaceBetween: 8,
        // PAGINATION DIHAPUS - tidak ada lagi
        on: {
          slideChange: function() {
            const index = this.realIndex;
            document.getElementById('currentKaryawanIndex').value = index;
            
            const previousIndex = this.previousIndex;
            if (previousIndex >= 0 && previousIndex < currentKaryawanList.length) {
              savePenilaianForKaryawan(previousIndex);
            }
            
            resetAllSlidersToZero();
            loadPenilaianForKaryawan(index);
            updateActiveKaryawan(index);
            
            // Update tombol panah
            if (currentKaryawanList.length > 1) {
              document.getElementById('prevKaryawan').disabled = index === 0;
              document.getElementById('nextKaryawan').disabled = index === currentKaryawanList.length - 1;
            }
          }
        }
      });
    }

    // ============ RENDER INDICATOR ============
    function renderKaryawanIndicator() {
      const container = document.getElementById('karyawanIndicator');
      container.innerHTML = '';
      
      currentKaryawanList.forEach((k, index) => {
        const key = k.nama;
        const isFilled = penilaianState[key] && Object.values(penilaianState[key]).some(v => v > 0);
        const isActive = index === parseInt(document.getElementById('currentKaryawanIndex').value);
        
        const indicator = document.createElement('span');
        indicator.className = `karyawan-indicator ${isActive ? 'active' : ''} ${isFilled ? 'filled' : ''}`;
        indicator.setAttribute('data-index', index);
        indicator.setAttribute('title', `${k.nama} - ${isFilled ? 'Sudah dinilai' : 'Belum dinilai'}`);
        
        indicator.addEventListener('click', () => {
          if (swiperInstance) swiperInstance.slideTo(index);
        });
        
        container.appendChild(indicator);
      });
    }

    // ============ UPDATE ACTIVE KARYAWAN ============
    function updateActiveKaryawan(index) {
      document.querySelectorAll('.karyawan-card').forEach((card, i) => {
        if (i === index) {
          card.classList.add('bg-blue-50', 'border-blue-500', 'border-2');
        } else {
          card.classList.remove('bg-blue-50', 'border-blue-500', 'border-2');
        }
      });
      
      const karyawan = currentKaryawanList[index];
      if (karyawan) {
        document.getElementById('nama').value = karyawan.nama;
        document.getElementById('posisi').value = karyawan.jabatan;
      }
      
      renderKaryawanIndicator();
    }

    // ============ LOAD PENILAIAN UNTUK KARYAWAN ============
    function loadPenilaianForKaryawan(index) {
      if (!currentKaryawanList.length || index >= currentKaryawanList.length) return;
      
      const karyawan = currentKaryawanList[index];
      const key = karyawan.nama;
      const nilai = penilaianState[key] || {};
      
      SLIDER_NAMES.forEach(sliderName => {
        const slider = document.querySelector(`input[name="${sliderName}"]`);
        if (slider) {
          const savedValue = nilai[sliderName] || 0;
          slider.value = savedValue;
          setRangeVisual(slider);
        }
      });
    }

    // ============ SIMPAN PENILAIAN UNTUK SATU KARYAWAN ============
    function savePenilaianForKaryawan(index) {
      if (!currentKaryawanList.length || index >= currentKaryawanList.length) return;
      
      const karyawan = currentKaryawanList[index];
      const key = karyawan.nama;
      
      if (!penilaianState[key]) {
        penilaianState[key] = {};
      }
      
      SLIDER_NAMES.forEach(sliderName => {
        const slider = document.querySelector(`input[name="${sliderName}"]`);
        if (slider) {
          penilaianState[key][sliderName] = parseInt(slider.value) || 0;
        }
      });
      
      renderKaryawanIndicator();
      updateKaryawanBadge(index);
    }

    // ============ UPDATE BADGE KARYAWAN ============
    function updateKaryawanBadge(index) {
      const karyawan = currentKaryawanList[index];
      if (!karyawan) return;
      
      const key = karyawan.nama;
      const isFilled = penilaianState[key] && Object.values(penilaianState[key]).some(v => v > 0);
      
      const card = document.querySelector(`.karyawan-card[data-index="${index}"]`);
      if (card) {
        const existingBadge = card.querySelector('.badge-dinilai');
        if (isFilled) {
          if (!existingBadge) {
            const badge = document.createElement('span');
            badge.className = 'badge-dinilai';
            badge.textContent = '✓';
            card.appendChild(badge);
          }
        } else {
          if (existingBadge) existingBadge.remove();
        }
      }
    }

    // ============ SLIDER VISUAL ============
    function setRangeVisual(r) {
      const pct = ((r.value - r.min) / (r.max - r.min)) * 100;
      r.style.setProperty('--pos', pct + '%');
      const badge = document.querySelector(`.val-badge[data-for="${r.name}"]`);
      if (badge) badge.textContent = r.value;
    }

    function initSliders() {
      document.querySelectorAll('input[type="range"]').forEach(r => {
        setRangeVisual(r);
        r.addEventListener('input', function() {
          setRangeVisual(r);
          
          const currentIndex = parseInt(document.getElementById('currentKaryawanIndex').value);
          if (currentIndex >= 0 && currentKaryawanList[currentIndex]) {
            const karyawan = currentKaryawanList[currentIndex];
            const key = karyawan.nama;
            
            if (!penilaianState[key]) {
              penilaianState[key] = {};
            }
            
            penilaianState[key][r.name] = parseInt(r.value) || 0;
            
            renderKaryawanIndicator();
            updateKaryawanBadge(currentIndex);
          }
        });
      });
    }

    // ============ VALIDASI & SUBMIT ============
    function validateForm() {
      if (!document.getElementById('periode').value) return { ok: false, msg: 'Pilih periode evaluasi' };
      if (!document.getElementById('namaPenilai').value) return { ok: false, msg: 'Pilih nama penilai' };
      if (!document.getElementById('nama').value) return { ok: false, msg: 'Pilih karyawan yang dinilai' };
      return { ok: true };
    }

    // ============ CALCULATIONS ============
    const CONFIG = {
      kompetensi: { maxTotal: 3 * 20, weight: 20 },
      kapasitas: { maxTotal: 2 * 20, weight: 10 },
      profesional: { maxTotal: 9 * 50, weight: 40 },
      karakter: { maxTotal: 10 * 40, weight: 30 }
    };
    const DENOM = CONFIG.kompetensi.maxTotal + CONFIG.kapasitas.maxTotal +
                  CONFIG.profesional.maxTotal + CONFIG.karakter.maxTotal;

    function sumBy(cls) { 
      return [...document.querySelectorAll(`input.${cls}`)].reduce((a,e)=>a+(+e.value||0),0); 
    }
    
    function calcAll() {
      const sumKom = sumBy('kompetensi'), 
            sumKap = sumBy('kapasitas'), 
            sumProf = sumBy('profesional'), 
            sumKar = sumBy('karakter');
      
      const pct = { 
        kom: sumKom / CONFIG.kompetensi.maxTotal * 100,
        kap: sumKap / CONFIG.kapasitas.maxTotal * 100,
        prof: sumProf / CONFIG.profesional.maxTotal * 100,
        kar: sumKar / CONFIG.karakter.maxTotal * 100 
      };
      
      const w = { 
        kom: pct.kom * CONFIG.kompetensi.weight / 100,
        kap: pct.kap * CONFIG.kapasitas.weight / 100,
        prof: pct.prof * CONFIG.profesional.weight / 100,
        kar: pct.kar * CONFIG.karakter.weight / 100 
      };
      
      const weighted = w.kom + w.kap + w.prof + w.kar;
      const rawSum = sumKom + sumKap + sumProf + sumKar;
      const overall = rawSum / DENOM * 100;

      let conclusion = 'Sangat Kurang';
      if (overall >= 90) conclusion = 'Unggul';
      else if (overall >= 80) conclusion = 'Baik';
      else if (overall >= 69) conclusion = 'Perlu Pengembangan';
      else if (overall >= 58) conclusion = 'Kurang';

      return { weighted, overall, conclusion };
    }

    // ============ CHECK FORM COMPLETION ============
    function checkFormCompletion() {
      const periode = document.getElementById('periode').value;
      const penilai = document.getElementById('namaPenilai').value;
      const nama = document.getElementById('nama').value;
      
      const btnSubmit = document.getElementById('btnSubmit');
      btnSubmit.disabled = !(periode && penilai && nama);
    }

    // ============ EVENT LISTENERS ============
    document.getElementById('periode').addEventListener('change', checkFormCompletion);
    
    document.getElementById('namaPenilai').addEventListener('change', async e => {
      const opt = e.target.selectedOptions[0];
      const dept = opt?.dataset.departemen || '';
      document.getElementById('departemen').value = dept;
      
      penilaianState = {};
      currentKaryawanList = [];
      document.getElementById('nama').value = '';
      document.getElementById('posisi').value = '';
      document.getElementById('currentKaryawanIndex').value = '-1';
      
      resetAllSlidersToZero();

      if (dept) {
        await loadKaryawanByDept(dept);
      } else {
        document.getElementById('loadingKaryawan').classList.add('hidden');
        document.getElementById('sectionKaryawan').classList.add('hidden');
        document.getElementById('noKaryawanMessage').classList.remove('hidden');
        document.getElementById('noKaryawanMessage').textContent = 'Pilih penilai terlebih dahulu';
      }
      
      checkFormCompletion();
    });

    document.getElementById('prevKaryawan').addEventListener('click', () => {
      if (swiperInstance) swiperInstance.slidePrev();
    });

    document.getElementById('nextKaryawan').addEventListener('click', () => {
      if (swiperInstance) swiperInstance.slideNext();
    });

    function initStickyEffect() {
      const stickySection = document.getElementById('karyawanSection');
      if (!stickySection) return;
      
      const observer = new IntersectionObserver(
        ([e]) => {
          if (e.target.classList.contains('sticky-karyawan')) {
            if (e.intersectionRatio < 1) {
              e.target.classList.add('is-sticky');
            } else {
              e.target.classList.remove('is-sticky');
            }
          }
        },
        { threshold: [0, 1] }
      );
      
      observer.observe(stickySection);
    }

    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', () => {
      initSliders();
      loadPenilai();
      initStickyEffect();
      document.getElementById('btnSubmit').disabled = true;

      document.getElementById('formEval').addEventListener('submit', async e => {
        e.preventDefault();
        
        const currentIndex = parseInt(document.getElementById('currentKaryawanIndex').value);
        if (currentIndex >= 0) savePenilaianForKaryawan(currentIndex);
        
        const v = validateForm();
        if (!v.ok) return alert(v.msg);

        const karyawan = currentKaryawanList[currentIndex];
        if (!karyawan) return alert('Pilih karyawan terlebih dahulu');

        const calc = calcAll();
        const payload = {
          departemen: document.getElementById('departemen').value,
          namaPenilai: document.getElementById('namaPenilai').value,
          jabatanPenilai: document.getElementById('jabatanPenilai')?.value || '',
          nama: karyawan.nama,
          posisi: karyawan.jabatan,
          periode: document.getElementById('periode').value,
          sliderDetail: SLIDER_NAMES.map(name => ({
            name: name,
            value: penilaianState[karyawan.nama]?.[name] || 0
          })),
          lastWeighted: calc.weighted.toFixed(2),
          lastOverall: calc.overall.toFixed(2),
          lastConclusion: calc.conclusion
        };

        const btnSubmit = document.getElementById('btnSubmit');
        btnSubmit.disabled = true; 
        btnSubmit.textContent = 'Loading...';

        try {
          const fd = new FormData();
          fd.append('action', 'submitPenilaian');
          fd.append('data', JSON.stringify(payload));
          const res = await fetch(GAS_URL, { method:'POST', body:fd });
          const json = await res.json();
          
          if (json.success) {
            alert(`Penilaian untuk ${karyawan.nama} berhasil`);
            
            if (currentIndex + 1 < currentKaryawanList.length) {
              swiperInstance.slideTo(currentIndex + 1);
            } else {
              if (confirm('Semua karyawan sudah dinilai. Reset form?')) {
                location.reload();
              }
            }
          } else {
            alert('❌ ' + (json.error || 'Gagal menyimpan data'));
          }
        } catch(e) { 
          alert('❌ Error: '+e.message); 
        } finally { 
          btnSubmit.disabled=false; 
          btnSubmit.textContent='Submit'; 
        }
      });
    });
  </script>
</body>
</html>
